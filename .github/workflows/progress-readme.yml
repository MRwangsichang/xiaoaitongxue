name: Progress README Bot

on:
  push:
    branches: [ "main" ]
    paths: [ "progress.json" ]
  workflow_dispatch: {}

jobs:
  update_readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate JSON
        id: val
        run: |
          if jq . progress.json >/dev/null; then
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Build progress block
        if: steps.val.outputs.ok == 'true'
        run: |
          PROJECT=$(jq -r '.title // .project // "未命名"' progress.json)
          PHASE=$(jq -r '.phase // "未设置"' progress.json)
          UPDATED=$(jq -r '.updated_at // "未填写"' progress.json)
          {
            echo "**项目：** $PROJECT  "
            echo "**阶段：** $PHASE  "
            echo "**更新时间：** $UPDATED"
            echo ""
            echo "**里程碑：**"
            jq -r '.milestones[]? | "- " + (.title // .name // "未命名") + (if .due then "（截止 " + .due + "）" else "" end)' progress.json || true
          } > block.md

      - name: Inject block into README
        if: steps.val.outputs.ok == 'true'
        run: |
          python3 - <<'PY'
          import re, pathlib
          p = pathlib.Path("block.md")
          block = p.read_text(encoding="utf-8")
          readme = pathlib.Path("README.md")
          text = readme.read_text(encoding="utf-8")
          start = "<!-- progress:start -->"
          end = "<!-- progress:end -->"
          pat = re.compile(re.escape(start)+r".*?"+re.escape(end), flags=re.S)
          new = start + "\n" + block + "\n" + end
          if start in text and end in text:
              text = pat.sub(new, text)
          else:
              lines = text.splitlines()
              for i, ln in enumerate(lines):
                  if ln.strip().startswith("#"):
                      lines.insert(i+1, "\n"+new+"\n")
                      break
              else:
                  lines.insert(0, new+"\n")
              text = "\n".join(lines)
          readme.write_text(text, encoding="utf-8")
          PY

      - name: Create PR
        if: steps.val.outputs.ok == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'docs(readme): auto-update progress section'
          title: 'docs: update progress section (bot)'
          body: |
            Auto-updated the README progress section from `progress.json`.
          branch: bot/update-progress-readme
          delete-branch: true
